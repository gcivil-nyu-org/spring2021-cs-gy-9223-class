{% extends 'base.html' %} {% load static %} {% block content %}
{% load mathfilters %}
<!-- Hero Section-->
<section class="pt-7 pb-5 d-flex align-items-end dark-overlay bg-cover" id="res_img">
  <div class="container overlay-content">
    <div class="d-flex justify-content-between align-items-start flex-column flex-lg-row align-items-lg-end">
      <div class="text-white mb-4 mb-lg-0">
        <div id="res_category" class="badge badge-pill badge-transparent px-3 py-2
        mb-4"></div>
        <h1 id="res-name" class="text-shadow verified">}</h1>
        <p><i class="fas fa-map-marker-alt mr-2"></i><span id="res-display-addr"></span></p>
        <p class="mb-0 d-flex align-items-center">
          <span id="res_rev_star"></span>
          &nbsp;&nbsp;
          <span id="res_review_count" class="ml-4"></span>
          <span>&nbsp;Reviews</span>
          <button class="btn btn-sm btn-primary ml-3" data-toggle="modal" data-target="#exampleModal">
            <i class="fa fa-star"></i>
            Write a review
          </button>
          <div id="div_mopd"></div>
        </p>
      </div>
    </div>
    </div>
</section>
<section class="py-6">
  <div class="container">
    <div class="row">
      <div class="col-lg-8">
        <div class="text-block">
          <h3 class="mb-4">
            <form name="saved_res_remove" id="saved_res_remove" class="saved_res_remove" onsubmit="return false;" res_business_id="" method="POST">
              Compliance Data

            {% if user.is_authenticated %}
                <button type="submit" class="btn"  data-toggle="tooltip" data-placement="top" data-original-title="save/remove">

                    {% if saved_restaurants %}
                    <i id="iconid" class="fa fa-heart fa-2x" style="color: #ff0000;"></i>
                    {% else %}
                    <i id="iconid" class="fa fa-heart fa-2x"></i>
                    {% endif %}
                </button>
            {% else %}
                <button id="log_in_to_save" class="btn"  data-toggle="tooltip" data-placement="top" data-original-title="log in to save" >
                <i id="iconid" class="fa fa-heart fa-2x"></i>
                  <script>
                    document.getElementById("log_in_to_save").onclick = function() {
                    location.href = "{% url 'user:login' %}";
                }
                  </script>
            {% endif %}
            </form>
          </h3>
          <div class="list-group shadow">
            <a class="list-group-item list-group-item-action p-4" href="/restaurant/inspection_records/{{ restaurant_id }}">
              <div class="row text-center">
                <div class="col-lg-4 align-self-center mb-4 mb-lg-0">
                    <h6 class="label-heading">Most Recent Status</h6>
                  <span id="res_compliance_status" class="badge badge-pill p-2 badge-success-light" style="font-size: inherit;"></span>
                </div>
                <div class="col-lg-8">
                  <div class="row text-center">
                    <div class="col-6 col-md-6 col-lg-6 py-3 mb-3 mb-lg-0">
                      <h6 class="label-heading">Skipped Reason </h6>
                      <p id="res_skipped_reason" class="text-sm font-weight-bold"></p>
                    </div>
                    <div class="col-6 col-md-6 col-lg-6 py-3">
                      <h6 class="label-heading">Inspection Date </h6>
                      <p id="res_last_inspection" class="text-sm font-weight-bold mb-0"></p>
                    </div>
                  </div>
                </div>
              </div>
            </a>
            <a class="list-group-item list-group-item-action p-4">
              <div class="d-flex flex-row justify-content-between">

                <h5>Safety Statistics
                  <!--{% if not statistics_dict.valuable_avg_safety_rating == 0 %}-->
                  <!--<span class="badge badge-primary-light">{{ statistics_dict.valuable_avg_safety_rating|floatformat:1 }}/5</span>-->
                  <!--{% endif %}-->
                </h5>
                {% if messages %}
                {% for message in messages %}
                {% if message %}
                <span class="badge badge-primary-light"><h6>Thanks for your feedback!</h6></span>
                {% endif %}
                {% endfor %}
                {% elif user.is_authenticated %}
                <button type="button" class="btn btn-link" data-toggle="modal" data-target="#exampleModal">Submit Feedback?</button>
                {% endif %}
              </div>

                <h6 class="mb-4" style="text-decoration: none; font-size: 12px;">
                  User submitted data that will help judge restaurant safety
                </h6>
              {% if statistics_dict.valuable_avg_safety_rating == 0 %}
                <div class="row text-center justify-content-md-center">
                  No user submitted data available
                </div>
              {% else %}
              <div class="row text-center justify-content-md-center">
                <div class="col-md-4">
                <canvas id="temp_check_chart"></canvas>
                <script>
                  var temp_check_true = {{ statistics_dict.temp_check_true }};
                  var temp_check_false = {{ statistics_dict.temp_check_false }};
                var ctx = document.getElementById('temp_check_chart').getContext('2d');
                var myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Yes', 'No'],
                        datasets: [{
                            label: 'Temperature Check',
                            data: [temp_check_true, temp_check_false],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 99, 132, 0.2)'

                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)'

                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        title: {
                          display: true,
                          text: 'Temperature Check',
                          fontSize: 15
                      },
                        legend: {
                          display: false,
                        },
                        responsive: true
                    }
                });
                </script>
                  </div>
                <div class="col-md-4">
                  <canvas id="contact_info_tracing_chart"></canvas>
                <script>
                  var contact_info_required_true = {{ statistics_dict.contact_info_required_true }};
                  var contact_info_required_false = {{ statistics_dict.contact_info_required_false }};
                var ctx = document.getElementById('contact_info_tracing_chart');
                var myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Yes', 'No'],
                        datasets: [{
                            data: [contact_info_required_true, contact_info_required_false],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 99, 132, 0.2)'

                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)'

                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        title: {
                          display: true,
                          text: 'Contact Info Tracing',
                          fontSize: 15
                      },
                      legend: {
                      display: false,
                      }
                    }
                });
                </script>
                </div>
                <div class="col-md-4">
                  <canvas id="employee_mask_chart"></canvas>
                <script>
                  var employee_mask_true = {{ statistics_dict.employee_mask_true }};
                  var employee_mask_false = {{ statistics_dict.employee_mask_false }};
                var ctx = document.getElementById('employee_mask_chart');
                var myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Yes', 'No'],
                        datasets: [{
                            label: 'Temperature Check',
                            data: [employee_mask_true, employee_mask_false],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 99, 132, 0.2)'

                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)'

                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        title: {
                          display: true,
                          text: 'Staff Wearing Mask',
                          fontSize: 15
                      },
                      legend: {
                      display: false,
                      }
                    }
                });
                </script>
                </div>
                <div class="col-md-4 mt-2">
                    <canvas id="capacity_compliant_chart"></canvas>
                <script>
                  var capacity_compliant_true = {{ statistics_dict.capacity_compliant_true }};
                  var capacity_compliant_false = {{ statistics_dict.capacity_compliant_false }};
                var ctx = document.getElementById('capacity_compliant_chart');
                var myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Yes', 'No'],
                        datasets: [{
                            label: 'Temperature Check',
                            data: [capacity_compliant_true, capacity_compliant_false],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 99, 132, 0.2)'

                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)'

                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        title: {
                          display: true,
                          text: 'Capacity under 25%',
                          fontSize: 15
                      },
                      legend: {
                      display: false,
                      }
                    }
                });
                </script>
                  </div>
                  <div class="col-md-4 mt-2">
                    <canvas id="distance_compliant_chart"></canvas>
                <script>
                  var distance_compliant_true = {{ statistics_dict.distance_compliant_true }};
                  var distance_compliant_false = {{ statistics_dict.distance_compliant_false }};
                var ctx = document.getElementById('distance_compliant_chart');
                var myChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Yes', 'No'],
                        datasets: [{
                            label: 'Temperature Check',
                            data: [distance_compliant_true, distance_compliant_false],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 99, 132, 0.2)'

                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 99, 132, 1)'

                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        title: {
                          display: true,
                          text: 'Distance Compliant',
                          fontSize: 15
                      },
                      legend: {
                      display: false,
                      }
                    }
                });
                </script>
                  </div>
                </div>
              {% endif %}
            </a>
          </div>
          <div class="text-block">
          </div>


{#              {% if saved_restaurants %}#}
{#              <!-- Button trigger delete restaurant from favorite -->#}
{#              <button type="button" class="fa fa-heart fa-2x" data-toggle="modal" data-target="#delete_favorite" id="delete_fav_button" >#}
{#                Remove from favorite#}
{#              </button>#}
{#              {% else %}#}
{#                <!-- Button trigger save restaurant as favorite -->#}
{#                <button type="button" class="fa fa-heart fa-2x" data-toggle="modal" data-target="#save_favorite" id="save_fav_button" color="red" >#}
{#                  Do you like this restaurant?#}
{#                </button>#}
{##}
{#              {% endif %}#}
        </div>

          <!-- Save Favorite Restaurant -->
        <div class="modal fade" id="save_favorite" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <form class="form-validate" method="POST">
                  {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="save_favorite_label">Save this restaurant to your favorite list?</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <input type="text" id="restaurant_business_id_save_favorite" name="restaurant_business_id" value="" hidden>
                <input type="text" id="user_id_save_favorite" name="user_id" value="{{user.id}}" hidden required>
              </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button class="btn btn-primary" type="submit" name="save_favorite_form">Yes</button>
                </div>
             </form>
            </div>
          </div>
        </div>
        <!--Zoom Picture Style-->
        <style>
      
          /* The Modal (background) */
          .modal1 {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 9999; /* Sit on top */
            padding-top: 100px; /* Location of the box */
            left: 0;
            top: 10px;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgb(0,0,0); /* Fallback color */
            background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
          }
          
          /* Modal Content (image) */
          .modal1-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
          }
    
          
          /* Add Animation */
          .modal1-content {  
            -webkit-animation-name: zoom;
            -webkit-animation-duration: 0.6s;
            animation-name: zoom;
            animation-duration: 0.6s;
          }
          
          @-webkit-keyframes zoom {
            from {-webkit-transform:scale(0)} 
            to {-webkit-transform:scale(1)}
          }
          
          @keyframes zoom {
            from {transform:scale(0)} 
            to {transform:scale(1)}
          }
          
          /* The Close Button */
          .close1 {
            position: absolute;
            top: 25px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
          }
          
          .close1:hover,
          .close1:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
          }
          
          /* 100% Image Width on Smaller Screens */
          @media only screen and (max-width: 700px){
            .modal1-content {
              width: 100%;
            }
          }
          </style>
        <!-- Zoom Picture -->
        <div id="myModal" class="modal1">
          <span class="close1">&times;</span>
          <img class="modal1-content" id="img01">
        </div>
        <script>
          // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close1")[0];
        // When the user clicks on <span> (x), close the modal
        span.onclick = function() { 
          var zoomModal = document.getElementById("myModal");
          zoomModal.style.display = "none";
        }
        </script>
          <!-- Delete Favorite Restaurant -->
        <div class="modal fade" id="delete_favorite" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <form class="form-validate" method="POST">
                  {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title" id="delete_favorite_label">Delete this restaurant from your favorite list?</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
                <input type="text" id="restaurant_business_id_delete_favorite" name="restaurant_business_id" value="" hidden>
                <input type="text" id="user_id_delete_favorite" name="user_id" value="{{user.id}}" hidden>
              </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                  <button class="btn btn-primary" type="submit" name="delete_favorite_form">Yes</button>
                </div>
             </form>
            </div>
          </div>
        </div>
        <div class="modal fade" id="report-abuse-modal" tabindex="-1" role="dialog" aria-labelledby="report-abuse-modal" aria-hidden="true">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <form class="form-validate" name="report-abuse" method="POST">
                  {% csrf_token %}
              <div class="modal-header py-2">
                <h5 class="modal-title">Report abuse</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <textarea class="form-control" name="reason" cols="30" rows="6"></textarea>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" type="submit">Submit</button>
              </div>
             </form>
            </div>
          </div>
        </div>


        
        <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Tell us about your experience!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <form class="form-validate" method="POST" name="rating-form" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                  <p class="mb-2">How would you rate this restaurant?</p>
                  <div class="form-group mb-2" style="width: 200px;">
                    <select class="selectpicker form-control" name="rating" data-style="btn-selectpicker" title="">
                      <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; (5/5)</option>
                      <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; (4/5)</option>
                      <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; (3/5)</option>
                      <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; (2/5)</option>
                      <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; (1/5)</option>
                    </select>
                  </div>
                  <p class="mb-2">How would you rate the safety of this restaurant?</p>
                  <div class="form-group mb-2" style="width: 200px;">
                    <select class="selectpicker form-control" name="rating_safety" data-style="btn-selectpicker" title="">
                      <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; (5/5)</option>
                      <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; (4/5)</option>
                      <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; (3/5)</option>
                      <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; (2/5)</option>
                      <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; (1/5)</option>
                    </select>
                  </div>
                  <p class="mb-2">How would you rate the accessibility of entry to this restaurant?</p>
                  <div class="form-group mb-2" style="width: 200px;">
                    <select class="selectpicker form-control" name="rating_entry" data-style="btn-selectpicker" title="">
                      <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; (5/5)</option>
                      <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; (4/5)</option>
                      <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; (3/5)</option>
                      <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; (2/5)</option>
                      <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; (1/5)</option>
                    </select>
                  </div>
                  <p class="mb-2">How would you rate the accessibility of doors at this restaurant?</p>
                  <div class="form-group mb-2" style="width: 200px;">
                    <select class="selectpicker form-control" name="rating_door" data-style="btn-selectpicker" title="">
                      <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; (5/5)</option>
                      <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; (4/5)</option>
                      <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; (3/5)</option>
                      <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; (2/5)</option>
                      <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; (1/5)</option>
                    </select>
                  </div>
                  <p class="mb-2">How would you rate the accessibility of tables at this restaurant?</p>
                  <div class="form-group mb-2" style="width: 200px;">
                    <select class="selectpicker form-control" name="rating_table" data-style="btn-selectpicker" title="">
                      <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; (5/5)</option>
                      <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; (4/5)</option>
                      <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; (3/5)</option>
                      <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; (2/5)</option>
                      <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; (1/5)</option>
                    </select>
                  </div>
                  <p class="mb-2">How would you rate the accessibility of bathrooms at this restaurant?</p>
                  <div class="form-group mb-2" style="width: 200px;">
                    <select class="selectpicker form-control" name="rating_bathroom" data-style="btn-selectpicker" title="">
                      <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; (5/5)</option>
                      <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; (4/5)</option>
                      <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; (3/5)</option>
                      <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; (2/5)</option>
                      <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; (1/5)</option>
                    </select>
                  </div>
                  <p class="mb-2">How would you rate the accessibility of pathways at this restaurant?</p>
                  <div class="form-group mb-2" style="width: 200px;">
                    <select class="selectpicker form-control" name="rating_path" data-style="btn-selectpicker" title="">
                      <option value="5">&#9733;&#9733;&#9733;&#9733;&#9733; (5/5)</option>
                      <option value="4">&#9733;&#9733;&#9733;&#9733;&#9734; (4/5)</option>
                      <option value="3">&#9733;&#9733;&#9733;&#9734;&#9734; (3/5)</option>
                      <option value="2">&#9733;&#9733;&#9734;&#9734;&#9734; (2/5)</option>
                      <option value="1">&#9733;&#9734;&#9734;&#9734;&#9734; (1/5)</option>
                    </select>
                  </div>
                  <input type="text" id="restaurant_business_id" name="restaurant_business_id" value="" hidden>
                  <input type="text" id="user_id" name="user_id" value="{{user.id}}" hidden>
                  <input type="text" id="saved_on" name="saved_on"   hidden>
                  {% comment %} <p class="mb-2">Did you receive a temperature check?</p>
                  <div class="form-group mb-2">
                    <input id="temp_check_true" type="radio" name="temperature_required" value="true" required/>
                    <label for="temp_check_true" title="text">Yes</label>
                    <input id="temp_check_false" type="radio" name="temperature_required" value="false" required/>
                    <label for="temp_check_false" title="text">No</label>
                  </div>
                  <p class="mb-2">Were you or a member of your party required to provide contact tracing information?</p>
                  <div class="form-group mb-2">
                    <input id="contact_true" type="radio" name="contact_info_required" value="true" required/>
                    <label for="contact_true" title="text">Yes</label>
                    <input id="contact_false" type="radio" name="contact_info_required" value="false" required/>
                    <label for="contact_false" title="text">No</label>
                  </div>
                  <p class="mb-2">Were restaurant staff wearing masks at all times?</p>
                  <div class="form-group mb-2">
                    <input id="employee_mask_true" type="radio" name="employee_mask" value="true" required/>
                    <label for="employee_mask_true" title="text">Yes</label>
                    <input id="employee_mask_false" type="radio" name="employee_mask" value="false" required/>
                    <label for="employee_mask_false" title="text">No</label>
                  </div>
                  <p class="mb-2">Was in-door capacity under 25%?</p>
                  <div class="form-group mb-2">
                    <input id="capacity_true" type="radio" name="capacity_compliant" value="true" required/>
                    <label for="capacity_true" title="text">Yes</label>
                    <input id="capacity_false" type="radio" name="capacity_compliant" value="false" required/>
                    <label for="capacity_false" title="text">No</label>
                  </div>
                  <p class="mb-2">Were you seated at least 6 feet from the nearest party?</p>
                  <div class="form-group mb-2">
                    <input id="distance_compliant_true" type="radio" name="distance_compliant" value="true" required/>
                    <label for="distance_compliant_true" title="text">Yes</label>
                    <input id="distance_compliant_false" type="radio" name="distance_compliant" value="false" required/>
                    <label for="distance_compliant_false" title="text">No</label>
                  </div> {% endcomment %}
                  <p class="mb-2">Tell others about your thoughts!</p>
                  <div class="form-group mb-2">
                    <textarea class="form-control" name="content" id="content" cols="30" rows="5" required></textarea>
                  </div>
                  <label for="img"> Select image for Review Image 1: </label>
                  <div class="form-group mb-2">
                    <input type="file" class="form-control" name="image1" id="image1" accept="image/*" required></input>
                  </div>
                  <label for="img"> Select image for Review Image 2: </label>
                  <div class="form-group mb-2">
                    <input type="file" class="form-control" name="image2" id="image2" accept="image/*" required></input>
                  </div>
                  <label for="img"> Select image for Review Image 3: </label>
                  <div class="form-group mb-2">
                    <input type="file" class="form-control" name="image3" id="image3" accept="image/*" required></input>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                  <button class="btn btn-primary" type="button" data-toggle="tooltip" data-placement="top" data-original-title="All fields required. Incomplete form will not be saved" id="rating-submit-button">Submit</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="text-block">
          <div class="mb-3">
              <h3 class="mb-4">Map</h3>
              <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item"><a class="nav-link active" id="tab1" data-toggle="tab" href="#tab-Location" role="tab" aria-controls="tab1-content" aria-selected="true">Location</a></li>
                <li class="nav-item"><a class="nav-link" id="tab2" data-toggle="tab" href="#tab-heatmap" role="tab" aria-controls="tab2-content" aria-selected="false">Heat Map</a></li>
              </ul>
              <div class="tab-content">
                <div class="tab-pane fade active show" id="tab-Location" role="tabpanel" aria-labelledby="tab-Location">

                  <div class="map-wrapper-300 mb-3">
                    <div class="h-100" id="detailMap"></div>
                  </div>
                </div>
                <div class="tab-pane fade" id="tab-heatmap" role="tabpanel" aria-labelledby="tab-heatmap">

                  <div class="map-wrapper-300 mb-3">
                    <div class="h-100" id="detailMap2"></div>
                  </div>
                </div>
              </div>
          </div>
        </div>
        <div class="text-block">
          <h3 class="mb-4">Gallery</h3>
          <div id="gallery_imgs" class="row gallery ml-n1 mr-n1">

          </div>
        </div>
        <!-- Ask the Community Q&A CSS -->
        <style>
          .ask-community-container {
            overflow: scroll;
            max-height: 500px;
          }
          .ask-community-container::-webkit-scrollbar {
            display: none;
          }
          .text-block-question {
            font-size: 14px;
            padding-top: 10px;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            margin: 20px;
            line-height: 80%;
            width: 80%;
          }

          .text-block-answer {
            font-size: 12px;
            text-align: left;
            margin: 20px;
            padding-top: 10px;
            padding: 20px;
            width: 65%;
            border-radius: 5px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
            line-height: 80%;
          }
          .user-name {
            font-weight: bold;
            color: rgb(68, 68, 255);
            font-size: 14px;
            vertical-align: baseline;
            padding-right: 5px;
          }

          .question {
            color: rgb(34, 34, 34);
            font-size: 16px;
            vertical-align: baseline;
          }

          .answer {
            color: rgb(34, 34, 34);
            font-size: 14px;
            vertical-align: baseline;
          }

          .timestamp {
            color: rgb(99, 99, 99);
            font-size: 10px;
          }
        </style>
        <!-- Ask the Community Part, Show top 3 questions and the corresponding answers -->
        <div class="text-block">
          <h3 class="mb-4">Ask the community</h3>
          <div class="ask-community-container">
            {% for q in restaurant_question_list %}
            <div>
              <div class="text-block-question">
                <p class="user-name" style="float: left;">{{ q.user__username }}</p>
                <p class="timestamp" style="float: left;">{{ q.time }}</p>
                <hr></hr>
                <p class="question">{{ q.question }}</p>
                {% if q.answers|length < q.total_answers_count %}
                  <a href="/restaurant/profile/{{ restaurant_id }}/question/{{ q.id }}/1">View more answers</a>
                {% elif q.answers|length == 0 %}
                  <p>No answers yet. You can be the first!</p>
                  <a href="/restaurant/profile/{{ restaurant_id }}/question/{{ q.id }}/1">Answer</a>
                {% else %}
                  <a href="/restaurant/profile/{{ restaurant_id }}/question/{{ q.id }}/1">View question details</a>
                {% endif %}
              </div>
            {% for a in q.answers %}
              <center>
                <div class="text-block-answer">
                  <p class="user-name" style="float: left;">{{ a.user__username }}</p>
                  <p class="timestamp" style="float: left;">{{ a.time }}</p>
                  <hr></hr>
                  <p class="answer">{{ a.text }}</p>
                </div>
              </center>
            {% endfor %}
            </div>
          {% endfor %}
          </div>
          {% if total_question_count == 0 %}
            <p>DineLine users haven't asked any questions yet about <strong>{{ yelp_info.info.name }}</strong>.</p>
            <a href="/restaurant/profile/{{ restaurant_id }}/ask_community/1">Ask a question</a>
          {% else %}
            <a href="/restaurant/profile/{{ restaurant_id }}/ask_community/1">See all {{ total_question_count }} questions or Ask a question</a>
          {% endif %}
        </div>
        <!-- End Test Ask the Community Part -->
        <div class="text-block">
          <h3 class="mb-4">Reviews Summary</h3>
          <div class="d-flex">
            <div class="col-7 col-sm-8 col-lg-9">
              <div class="d-flex align-items-center">
                <span style="flex: 0 0 1.5rem;">5</span>
                <div class="h-100" style="flex: 1 1 auto;">
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ distribution.5 }}%;" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <span style="flex: 0 0 1.5rem;">4</span>
                <div class="h-100" style="flex: 1 1 auto;">
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ distribution.4 }}%;" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <span style="flex: 0 0 1.5rem;">3</span>
                <div class="h-100" style="flex: 1 1 auto;">
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ distribution.3 }}%;" aria-valuenow="6" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <span style="flex: 0 0 1.5rem;">2</span>
                <div class="h-100" style="flex: 1 1 auto;">
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ distribution.2 }}%;" aria-valuenow="2" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
              <div class="d-flex align-items-center">
                <span style="flex: 0 0 1.5rem;">1</span>
                <div class="h-100" style="flex: 1 1 auto;">
                  <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ distribution.1 }}%;" aria-valuenow="8" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="d-flex flex-column col-5 col-sm-4 col-md-3 justify-content-center">
              <h1 class="text-center">{{ ratings_avg }}</h1>
              <div class="text-center">
                <span class="btn-link" style="cursor: pointer;">{{ reviews_count }} reviews</span>
              </div>
            </div>
          </div>
          <hr>
          <h6>
            <span class="text-primary">YELP</span> REVIEWS
          </h6>
          <span id="yelp_review"></span>
          <hr>
          <h6>
            <span class="text-primary">INTERNAL</span> REVIEWS
          </h6>
          <span id="internal_review"></span>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="pl-xl-4">
          <!-- Opening Hours      -->
          <div class="card border-0 shadow mb-5">
            <div class="card-header bg-gray-100 py-4 border-0">
              <div class="media align-items-center">
                <div class="media-body">
<!--                  <p class="subtitle text-sm text-primary">Overnight Status : <span id="res_overnight_status"></span></p>-->
                  <h4 class="mb-0">Opening Hours </h4> </div>
                <svg class="svg-icon svg-icon svg-icon-light w-3rem h-3rem ml-3 text-muted">
                  <use xlink:href="#wall-clock-1"> </use>
                </svg>
              </div>
            </div>
            <div class="card-body">
              <table id="res_open_hours" class="table text-sm mb-0">

              </table>
            </div>
          </div>
          <!-- Contact-->
          <div class="card border-0 shadow mb-5">
            <div class="card-header bg-gray-100 py-4 border-0">
              <div class="media align-items-center">
                <div class="media-body">
                  <p class="subtitle text-sm text-primary">Want to know more?</p>
                  <h4 class="mb-0">Information</h4>
                </div>
                <svg class="svg-icon svg-icon svg-icon-light w-3rem h-3rem ml-3 text-muted">
                  <use xlink:href="#fountain-pen-1"> </use>
                </svg>
              </div>
            </div>
            <div class="card-body">
              <ul class="list-unstyled mb-4">
                <li class="mb-2">
                  <a class="text-gray-00 text-sm text-decoration-none">
                    <i class="fas fa-phone mr-3"></i>
                    <span id="res_display_phn" class="text-muted"></span>
                  </a>
                </li>
                <li class="mb-2">
                  <a class=" text-sm text-decoration-none">
                    <i class="fas fa-star mr-3"></i>
                    <span class="text-muted"><span id="res_rating_info"></span>
                        Stars</span>
                  </a>
                </li>
                <li class="mb-2">
                  <a class=" text-sm text-decoration-none">
                    <i class="fas fa-money-check-alt mr-3"></i>
                    <span id="res-price" class="text-muted"></span>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Recommedn restaurant  -->
    <!-- insert row here -->
    <div class="row">
        {% if recommended_restaurants  %}
        <h3 class="mb-4">Similar restaurants</h3>
        <div class="container-fluid">
           <!-- Slider main container-->
           <div class="swiper-container swiper-container-mx-negative items-slider-full px-lg-5 pt-3">
              <!-- Additional required wrapper-->
              <div class="swiper-wrapper pb-5">
                  {% for restaurant in recommended_restaurants %}
                  {% if not restaurant.yelp_info.fake_info %}
                  <div class="swiper-slide h-auto px-2">
                      <!-- venue item-->
                      <div class="w-100 h-100 hover-animate" data-marker-id="59c0c8e322f3375db4d89128">
                          <div class="card h-100 border-0 shadow">

                              <div class="card-img-top overflow-hidden dark-overlay bg-cover" style="background-image: url({{ restaurant.yelp_info.image_url }}); min-height: 200px;"><a class="tile-link" href="{% url 'restaurant:profile' restaurant.id %}"></a>
                                  <div class="card-img-overlay-bottom z-index-20">
                                      <h4 class="text-white text-shadow">{{ restaurant.yelp_info.name }}</h4>
                                      <p class="mb-2 text-xs">
                                          {% for i in "x"|ljust:restaurant.yelp_info.rating %}
                                              <i class="fa fa-star text-warning"></i>
                                          {% endfor %}
                                          {% with restaurant.yelp_info.rating|add:-5|abs as aa %}
                                          {% if aa == 0 %}
                                          {% else %}
                                          {% for i in "x"|ljust:aa %}
                                          <i class="fa fa-star text-gray-300"></i>
                                          {% endfor %}
                                          {% endif %}
                                          {% endwith %}
                                      </p>
                                  </div>
                              </div>
                              <div class="card-body">
                                  <p class="text-sm text-muted text-uppercase mb-1">
                                      <a href="{% url 'restaurant:inspection_history' restaurant.id %}" class="text-dark">{{ restaurant.latest_record.is_roadway_compliant }}</a>
                                      {% if restaurant.latest_record.is_roadway_compliant == "Compliant" %}
                                          <i class="fas fa-check-circle" style="color:#596ff8"></i>
                                      {% endif %}
                                  </p>
                                  <p class="text-sm mb-0">
                                      {% for cat in restaurant.yelp_info.categories %}
                                      <a class="mr-1 disabled text-decoration-none">{{ cat.title}}</a>
                                      {% endfor %}
                                  </p>
                              </div>
                          </div>
                      </div>
                  </div>
                  {% endif %}
                  {% endfor %}
              </div>
              <!-- If we need pagination-->
              <div class="swiper-pagination"></div>
          </div>
        </div>
        {% endif %}
    </div> <!-- row ends-->




  </div>
</section>

<!--Insert values into HTML-->
<script>
var inspection_data = {{ lasted_inspection | safe}};

document.getElementById("res_compliance_status").innerHTML = inspection_data.is_roadway_compliant;
document.getElementById("res_last_inspection").innerHTML = inspection_data.inspected_on;

var mopd_status = inspection_data.mopd_compliance;

var div_mopd = document.getElementById("div_mopd");
div_mopd.style = "margin:5px";

var p_m = document.createElement("span");
p_m.className = "text-sm text-uppercase mb-1";

var am = document.createElement("a");
am.className = "text-dark";

if(mopd_status == "Compliant"){
  p_m.className = "badge badge-pill badge-success";
  am.className = "text-light";
  am.style = "font-size:14px"
  am.innerHTML += "Compliant";
  am.innerHTML += "&nbsp";
  am.style = "text-decoration:none";
  var wheelchair = document.createElement("i");
  wheelchair.className = "fas fa-wheelchair";
  wheelchair.style = "color:white";
  p_m.appendChild(am);
  p_m.appendChild(wheelchair);
}

// Add MOPD Compliance Status to the div container 
div_mopd.appendChild(p_m);

if(inspection_data.is_roadway_compliant=="Compliant")
  {document.getElementById("res_compliance_status").className = "badge badge-pill p-2 badge-success-light"}
else
  {document.getElementById("res_skipped_reason").innerHTML = inspection_data.skipped_reason;
  document.getElementById("res_compliance_status").className = "badge badge-pill p-2 badge-danger-light"}
if(inspection_data.skipped_reason == "nan"){document.getElementById("res_skipped_reason").innerHTML = "-";}

var True = true;
var False = false;
var None = null;
var yelp_info = {{ yelp_info.info | safe }};
document.getElementById("saved_res_remove").setAttribute("res_business_id", yelp_info.id);
document.getElementById("iconid").setAttribute("id", yelp_info.id);
var keys = Object.keys(yelp_info);
var empty1 = [];
for (var i = 0; i < keys.length; i++) {
    var key = keys[i];
    if (yelp_info[key] == "" && typeof(yelp_info[key]) != 'boolean') {
        empty1.push(key);
    }
}
switch (false) {
    case (empty1.includes(name)):
        document.getElementById("res-name").innerHTML = yelp_info.name;
    case (empty1.includes(review_count)):
        document.getElementById("res_review_count").innerHTML = yelp_info.review_count;
    case (empty1.includes(rating)):
        document.getElementById("res_rating_info").innerHTML = Math.ceil(yelp_info.rating);
    case (empty1.includes(display_address)):
        document.getElementById("res-display-addr").innerHTML = yelp_info.location.display_address;
    case (empty1.includes(price)):
        document.getElementById("res-price").innerHTML = yelp_info.price;
    case (empty1.includes(display_phone)):
        document.getElementById("res_display_phn").innerHTML = yelp_info.display_phone;
    case (empty1.includes(image_url)):
        document.getElementById("res_img").style.backgroundImage = 'url(' + yelp_info.image_url + ')';
    case (empty1.includes(longitude)): var long = yelp_info.coordinates.longitude;
    case (empty1.includes(latitude)): var lat = yelp_info.coordinates.latitude;
}

var res_category = document.getElementById("res_category");
var str = "";
for (i = 0; i < yelp_info.categories.length; i++) {
    str += yelp_info.categories[i].title + ", ";
}
str = str.slice(0, -2);
res_category.innerHTML = str;

var res_rev_star = document.getElementById("res_rev_star");
var rate = yelp_info.rating;
for (j = 0; j < Math.ceil(rate); j++) {
    var icon = document.createElement("i");
    icon.className = "fa fa-xs fa-star text-primary";
    res_rev_star.appendChild(icon);
}
for (j = 0; j < 5 - Math.ceil(rate); j++) {
    var icon2 = document.createElement("i");
    icon2.className = "fa fa-xs fa-star text-gray-200";
    res_rev_star.appendChild(icon2);
}

function timeChangeFunc(x) {
  var hrs = parseInt(x.slice(0,2));
  var a = (hrs<12)?'AM':'PM';
  var mins = x.slice(2,4);
  hrs = hrs%12 || 12;
  return(hrs + ":" + mins + " " + a);
}

var days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
var day_time = [0, 0, 0, 0, 0, 0, 0];
for (i = 0; i < yelp_info.hours[0].open.length; i++) {
    var curr = yelp_info.hours[0].open[i].day;
    day_time[curr]++;
}
var prev_day = -1;
for (i = 0; i < yelp_info.hours[0].open.length; i++) {
    var opening_hours = document.getElementById("res_open_hours");
    var row = document.createElement("tr");
    opening_hours.appendChild(row);
    var curr_day = yelp_info.hours[0].open[i].day;
    if (curr_day != prev_day) {
        var thh = document.createElement("th");
        thh.className = "pl-0";
        thh.innerHTML = days[curr_day];
        thh.rowSpan = day_time[curr_day];
        row.appendChild(thh);
    }
    prev_day = curr_day;
    var tdd = document.createElement("td");
    tdd.className = "pr-0 text-right";
    tdd.innerHTML = timeChangeFunc(yelp_info.hours[0].open[i].start) + "-" + timeChangeFunc(yelp_info.hours[0].open[i].end);
    row.appendChild(tdd);
}

for (i = 0; i < yelp_info.photos.length; i++) {
    var gallery_imgs = document.getElementById("gallery_imgs");
    var ele = document.createElement("div");
    ele.className = "col-lg-4 col-6 px-1 mb-2";
    var a = document.createElement("a");
    a.href = yelp_info.photos[i];
    var img = document.createElement("img");
    img.className = "img-fluid";
    img.src = yelp_info.photos[i];

    a.appendChild(img);
    ele.appendChild(a);
    gallery_imgs.appendChild(ele);
}

document.getElementById('rating-submit-button').addEventListener('click', () => {
  document.forms['rating-form'].submit();
});

$('#exampleModal').on('hidden.bs.modal', function (e) {
  document.forms['rating-form'].removeAttribute('action');
})

const DEFAULT_AVATAR = 'https://s3-media3.fl.yelpcdn.com/photo/O8CmQtEeOUvMTFk0iMn5sw/o.jpg';
const isNull = el => el === 'null' || el === 'None' || el === null || el === undefined;
const restaurantId = '{{ restaurant_id }}' || '';
const userId = Number('{{ user_id | safe }}');
const REPORT_TYPE = {
  REVIEW: 'REVIEW',
  COMMENT: 'COMMENT'
};
let __data__ = {
  reportAbuse: {
    type: null,
    id: null
  }
};
document.forms['report-abuse'].addEventListener('submit', e => {
  e.preventDefault();
  if (__data__.reportAbuse.type === REPORT_TYPE.REVIEW) {
    e.target.setAttribute('action', `/restaurant/report/${restaurantId}/review/${__data__.reportAbuse.id}`);
  } else {
    e.target.setAttribute('action', `/restaurant/report/${restaurantId}/comment/${__data__.reportAbuse.id}`);
  }
  e.target.submit();
});
/**
 * Rating box view
 * @param {review-id} string
 * @param {profile-img} string
 * @param {profile-img-alt} string
 * @param {profile-url} string
 * @param {time-created} string
 * @param {user-name} string
 * @param {user-rating} string
 * @param {review-text} string
 * @param {authorId} string
 */
class RatingReview extends HTMLElement {
  constructor () {
    super();
    this.attachShadow({ mode: 'open' });

    this.addStyles();

    this.rootDiv = document.createElement('div');

    this.container = document.createElement('div');
    this.container.className = 'media d-block d-sm-flex review';
    this.container.setAttribute('style', 'border-bottom: 0; padding-bottom: 0;')

    // left side
    const userProfile = document.createElement('div');
    userProfile.className = 'text-md-center mr-4 mr-xl-5';
    this.avatar = document.createElement('img');
    this.avatar.className = 'd-block avatar avatar-xl p-2 mb-2';

    this.avatar.src = this.getAttribute('profile-img') || DEFAULT_AVATAR;
    this.avatar.alt = this.getAttribute('profile-img-alt') || '';
    this.createRatingTimestamp = document.createElement('span');
    this.createRatingTimestamp.className = 'text-uppercase text-muted text-sm';
    this.createRatingTimestamp.innerText = this.getAttribute('time-created') || '';
    
    userProfile.appendChild(this.avatar);
    userProfile.appendChild(this.createRatingTimestamp);

    // right side
    const ratingBody = document.createElement('div');
    ratingBody.className = 'media-body';
    
    // author link
    const author = document.createElement('h6');
    author.className = 'mt-2 mb-1';

    this.authorProfileLink = document.createElement('a');
    this.authorProfileLink.href = this.getAttribute('profile-url') || DEFAULT_AVATAR;
    this.authorProfileLink.innerText = this.getAttribute('user-name') || '';

    author.appendChild(this.authorProfileLink);
    ratingBody.appendChild(author);

    // rating stars
    this.ratingStars = document.createElement('div');
    const rating = Number(this.getAttribute('user-rating') || '');
    for (let i = 0; i < 5; i++) {
      const star = document.createElement('i');
      star.className = 'fa fa-xs fa-star';
      star.classList.add(i < rating ? 'text-primary' : 'text-gray-200');
      this.ratingStars.appendChild(star);
    }
    ratingBody.appendChild(this.ratingStars);

    // comments
    this.comments = document.createElement('p');
    this.comments.setAttribute('style', 'display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden;');
    this.comments.className = 'text-muted text-sm';
    this.comments.innerText = this.getAttribute('review-text');
    
    // 3 images
    this.image1 = document.createElement('img');
    this.image1.className= 'review-image';
    this.image1.src = this.getAttribute('image1');
    this.image1.setAttribute('style', 'display: none; object-fit: contain; height: 100px !important; align-items: center; margin-left: 5px;')

    this.image2 = document.createElement('img');
    this.image2.className= 'review-image';
    this.image2.src = this.getAttribute('image2');
    this.image2.setAttribute('style', 'display: none; object-fit: contain; height: 100px !important; align-items: center; margin-left: 5px;')

    this.image3 = document.createElement('img');
    this.image3.className= 'review-image';
    this.image3.src = this.getAttribute('image3');
    this.image3.setAttribute('style', 'display: none; object-fit: contain; height: 100px !important; align-items: center; margin-left: 5px;')

    this.image1.addEventListener('click', () => {
      var zoomModal = document.getElementById("myModal");
      zoomModal.style.display = "block";
      var modalImg = document.getElementById("img01");
      modalImg.src = this.image1.src;
      
    });

    this.image2.addEventListener('click', () => {
      var zoomModal = document.getElementById("myModal");
      zoomModal.style.display = "block";
      var modalImg = document.getElementById("img01");
      modalImg.src = this.image2.src;
      
    });

    this.image3.addEventListener('click', () => {
      var zoomModal = document.getElementById("myModal");
      zoomModal.style.display = "block";
      var modalImg = document.getElementById("img01");
      modalImg.src = this.image3.src;
      
    });

    this.serviceHint = document.createElement('em');
    this.serviceHint.setAttribute('style', 'display: none; font-size: 0.6rem; line-height: 0.8rem;');
    this.serviceHint.setAttribute('class', 'text-secondary');
    this.serviceHint.innerText = 'This post is only visible to you because it violates our terms of service';
    
    ratingBody.appendChild(this.comments);
    ratingBody.appendChild(this.image1);
    ratingBody.appendChild(this.image2);
    ratingBody.appendChild(this.image3);
    ratingBody.appendChild(this.serviceHint);

    this.container.appendChild(userProfile);
    this.container.appendChild(ratingBody);


    this.rootDiv.appendChild(this.container);
    
    this.shadowRoot.appendChild(this.rootDiv);
  }

  static get observedAttributes() {
    return ['profile-img', 'profile-img-alt', 'profile-url', 'time-created', 'user-name', 'user-rating', 'review-text', 'author-id', 'hidden-flag', 'image1', 'image2', 'image3'];
  }

  attributeChangedCallback(name, oldValue, newValue) {
    if (name === 'profile-img') {
      this.avatar.setAttribute('src', isNull(newValue) ? DEFAULT_AVATAR : newValue);
    } else if (name === 'profile-img-alt') {
      this.avatar.setAttribute('alt', newValue || '');
    } else if (name === 'time-created') {
      this.createRatingTimestamp.innerText = newValue || '';
    } else if (name === 'profile-url') {
      this.authorProfileLink.setAttribute('href', newValue || '');
    } else if (name === 'user-name') {
      this.authorProfileLink.innerText = newValue || '';
    } else if (name === 'user-rating') {
      const rating = Number(newValue || 0);
      new Array().forEach.call(this.ratingStars.children, (el, index) => {
        if (index < rating) {
          el.classList.replace('text-gray-200', 'text-primary');
        } else {
          el.classList.replace('text-primary', 'text-gray-200');
        }
      });
    } else if (name === 'review-text') {
      this.comments.innerText = newValue || '';
    } else if (name === 'author-id') {
      if (newValue === userId && this.hasAttribute('hidden-flag')) {
        this.rootDiv.style.opacity = 0.5;
      }
      this.attachOptionButton({ authorId: Number(newValue || '') });
    } else if (name === 'hidden-flag') {
      if (!newValue) return;
      this.container.removeChild(this.optionButtonWrapper);
      this.rootDiv.style.opacity = 0.5;
      this.serviceHint.style.display = 'inline-block';
      this.comments.style.webkitLineClamp = 2;
    } else if (name === 'image1' && !newValue.endsWith('/media/')) {
      this.image1.src = newValue;
      this.image1.style.display = "inline-block";
      var modalImg = document.getElementById("img01");
      modalImg.src = this.image1.src;
    } else if (name === 'image2' && !newValue.endsWith('/media/')) {
      this.image2.src = newValue;
      this.image2.style.display = "inline-block";
      var modalImg = document.getElementById("img01");
      modalImg.src = this.image2.src;
    } else if (name === 'image3' && !newValue.endsWith('/media/')) {
      this.image3.src = newValue;
      this.image3.style.display = "inline-block";
      var modalImg = document.getElementById("img01");
      modalImg.src = this.image3.src;
    }
  }

  attachOptionButton ({ authorId }) {
    if (!this.optionButton) {
      // option button
      this.optionButtonWrapper = document.createElement('div');
      this.optionButtonWrapper.setAttribute('class', 'dropdown');

      this.optionButton = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      this.optionButton.setAttribute('viewBox', '0 0 24 24');
      this.optionButton.setAttribute('preserveAspectRatio', 'xMidYMid meet');
      this.optionButton.setAttribute('style', 'display: inline-block; width: 1rem; height: 1rem; cursor: pointer;');
      this.optionButton.setAttribute('class', 'dropdown-toggle');
      this.optionButton.setAttribute('type', 'button');

      const optionWrapper = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      const optionPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      optionPath.setAttribute('d', 'M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z');
      optionWrapper.appendChild(optionPath);
      this.optionButton.appendChild(optionWrapper);

      // dropdown button wrapper
      this.dropdownWrapper = document.createElement('div');
      this.dropdownWrapper.setAttribute('class', 'dropdown-menu p-0');

      this.deleteForm = document.createElement('form');
      this.deleteForm.setAttribute('action', `/restaurant/profile/${this.getAttribute('restaurant-id')}/comment/${this.getAttribute('review-id')}/delete`);

      this.optionButtonWrapper.appendChild(this.optionButton);
      this.optionButtonWrapper.appendChild(this.dropdownWrapper);
      this.optionButtonWrapper.appendChild(this.deleteForm);
      this.optionButtonWrapper.addEventListener('mouseover', () => {
        this.dropdownWrapper.classList.add('show');
      });
      this.dropdownWrapper.addEventListener('mouseout', () => {
        this.dropdownWrapper.classList.remove('show');
      });

      this.container.appendChild(this.optionButtonWrapper);
    }

    new Array().forEach.call(this.dropdownWrapper.children, el => this.dropdownWrapper.removeChild(el));
    ['Edit', 'Delete', 'Reply', 'Report'].forEach((el, index) => {
      if (authorId !== userId && [0, 1].includes(index)) return;
      if (authorId === userId && index === 3) return;
      const anchor = document.createElement('a');
      anchor.setAttribute('class', 'dropdown-item small py-2');
      anchor.setAttribute('href', '#');      
      anchor.innerText = el;
      if (index === 0) {
        anchor.addEventListener('click', () => {
          $('#exampleModal').modal('toggle');
          const rating = document.querySelector('select[name="rating"]');
          rating.value = this.getAttribute('user-rating');
          rating.dispatchEvent(new Event('change'));
          const content = document.querySelector('textarea[name="content"]');
          content.value = this.getAttribute('review-text');
          content.dispatchEvent(new Event('change'));
          document.forms['rating-form'].setAttribute('action', `/restaurant/profile/${this.getAttribute('restaurant-id')}/comment/${this.getAttribute('review-id')}/put`);
        });
      } else if (index === 1) {
        anchor.addEventListener('click', () => this.deleteForm.submit());
      } else if (index === 2) {
        anchor.addEventListener('click', e => {
          e.preventDefault();
          this.dropdownWrapper.classList.remove('show');
          let form = this.rootDiv.querySelector('form[name="reply-form"]');
          if (form) {
            form.querySelector('input').focus();
            return;
          }

          form = document.createElement('form');
          form.setAttribute('name', 'reply-form');
          form.setAttribute('method', 'get');
          form.setAttribute('action', `/restaurant/profile/${restaurantId}/comment_edit/${this.getAttribute('review-id')}`);
          form.setAttribute('class', 'd-flex form-group mb-0');
          form.setAttribute('style', 'padding-left: 12%; align-items: baseline;');

          const line = document.createElement('div');
          line.setAttribute('style', 'border-bottom: 2px solid #e7e7e7; border-left: 2px solid #e7e7e7; border-radius: 5px; height: 40px; width: 50px;');

          const inputBox = document.createElement('input');
          inputBox.setAttribute('class', 'form-control form-control-sm');
          inputBox.setAttribute('name', 'text');

          const submitBtn = document.createElement('button');
          submitBtn.setAttribute('type', 'submit');
          submitBtn.setAttribute('class', 'btn btn-sm btn-primary ml-2');
          submitBtn.innerText = 'Submit';

          const cancelBtn = document.createElement('button');
          cancelBtn.setAttribute('type', 'button');
          cancelBtn.setAttribute('class', 'btn btn-sm btn-secondary ml-2');
          cancelBtn.innerText = 'Cancel';
          cancelBtn.addEventListener('click', () => {
            this.rootDiv.removeChild(form);
          });

          form.appendChild(line);
          form.appendChild(inputBox);
          form.appendChild(submitBtn);
          form.appendChild(cancelBtn);

          this.rootDiv.appendChild(form);
        });
      } else if (index === 3) {
        anchor.addEventListener('click', e => {
          e.preventDefault();
          this.dropdownWrapper.classList.remove('show');
          $('#report-abuse-modal').modal('show');
          __data__.reportAbuse.type = REPORT_TYPE.REVIEW;
          __data__.reportAbuse.id = this.getAttribute('review-id');
        });
      }
      this.dropdownWrapper.appendChild(anchor);
    });
  }

  /**
   * @params {profile} string - profile picture
   * @params {text} string - comment
   * @params {author} string - comment author
   * @params {commentId} string - comment id
   * @params {hidden} boolean - should display hidden hint if this is true
   */
  renderReplies ({ profile = DEFAULT_AVATAR, text = '', author = '', commentId = '', hidden = false }) {
    const commentContainer = document.createElement('div');
    commentContainer.className = 'd-flex';
    commentContainer.setAttribute('style', `padding-left: 12%; align-items: baseline; ${hidden ? 'opacity: 0.5;' : ''}`);

    const line = document.createElement('div');
    line.setAttribute('style', 'border-bottom: 2px solid #e7e7e7; border-left: 2px solid #e7e7e7; border-radius: 5px; height: 40px; width: 50px;');

    const replyContainer = document.createElement('div');
    replyContainer.setAttribute('style', 'width: calc(100% - 50px)');
    
    const replyAvatar = document.createElement('img');
    replyAvatar.setAttribute('style', 'width: 40px; height: 40px; border-radius: 50%;');
    replyAvatar.setAttribute('src', profile);

    const replyBox = document.createElement('div');
    replyBox.setAttribute('style', `display: inline-block; margin-left: 1rem; width: ${hidden ? '50%' : '70%'}; vertical-align: middle;`);
    replyBox.setAttribute('class', 'text-muted text-sm text-truncate');
    replyBox.innerText = text;

    replyContainer.appendChild(replyAvatar);
    replyContainer.appendChild(replyBox);
    
    // hide report / delete button if this post is hidden
    if (!hidden) {
      const deleteForm = document.createElement('form');
      deleteForm.setAttribute('method', 'get');
      deleteForm.setAttribute('action', `/restaurant/profile/${restaurantId}/comment_delete/${commentId}`);
      deleteForm.setAttribute('class', 'd-inline-block');
      if (userId === Number(author)) {
        const deleteButton = document.createElement('span');
        deleteButton.setAttribute('class', 'fas fa-backspace text-primary btn btn-sm ml-1');
        deleteButton.addEventListener('click', () => {
          deleteForm.submit();
        });
        deleteForm.appendChild(deleteButton);
      }
      if (!isNull(userId) && userId != Number(author)) {
        const reportButton = document.createElement('span');
        reportButton.setAttribute('class', 'fas fa-flag text-secondary btn btn-sm ml-1');
        reportButton.addEventListener('click', () => {
          $('#report-abuse-modal').modal('show');
          __data__.reportAbuse.type = REPORT_TYPE.COMMENT;
          __data__.reportAbuse.id = commentId;
        });
        deleteForm.appendChild(reportButton);
      }

      replyContainer.appendChild(deleteForm);
    } else {
      const hint = document.createElement('em');
      hint.classList.add('text-secondary');
      hint.style.fontSize = '0.6rem';
      hint.innerText = 'This comment is only visible to you';
      replyContainer.appendChild(hint);
    }

    commentContainer.appendChild(line);
    commentContainer.appendChild(replyContainer);

    this.rootDiv.appendChild(commentContainer);
  }

  // add web component styles
  addStyles () {
    const styleLinks = [
      'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css',
      '/static/css/style.default.452e11c7.css',
      '/static/css/all.css'
    ]

    styleLinks.forEach(el => {
      const styles = document.createElement('link');
      styles.setAttribute('rel', 'stylesheet');
      styles.setAttribute('href', el);
      this.shadowRoot.appendChild(styles);
    });
  }
};
customElements.define('rating-review', RatingReview);
const yelpReviews = {{ yelp_info.reviews | safe }};

yelpReviews['reviews'].forEach(review => {
  const reviewWrapper = document.getElementById('yelp_review');
  const ratingReview = document.createElement('rating-review');
  ratingReview.setAttribute('profile-img', review.user.image_url);
  ratingReview.setAttribute('profile-img-alt', review.user.name);
  ratingReview.setAttribute('profile-url', review.user.profile_url);
  ratingReview.setAttribute('user-name', review.user.name);
  ratingReview.setAttribute('time-created', review.time_created);
  ratingReview.setAttribute('user-rating', review.rating);
  ratingReview.setAttribute('review-text', review.text);
  reviewWrapper.appendChild(ratingReview);
});

const internalReviews = {{ internal_reviews | safe }};
internalReviews.forEach(review => {
  if (review.hidden && review.user !== userId) return;
  const reviewWrapper = document.getElementById('internal_review');
  const ratingReview = document.createElement('rating-review');
  ratingReview.setAttribute('profile-img', review.user__user_profile__photo);
  ratingReview.setAttribute('profile-img-alt', review.user__username);
  ratingReview.setAttribute('profile-url', `/user/facing_page/${review.user}`);
  ratingReview.setAttribute('user-name', review.user__username);
  ratingReview.setAttribute('time-created', review.time);
  ratingReview.setAttribute('user-rating', review.rating);
  ratingReview.setAttribute('review-text', review.content);
  ratingReview.setAttribute('review-id', review.id);
  ratingReview.setAttribute('restaurant-id', restaurantId);
  ratingReview.setAttribute('author-id', review.user);
  ratingReview.setAttribute('image1', 'https://dineline.s3.amazonaws.com/media/' + review.image1);
  ratingReview.setAttribute('image2', 'https://dineline.s3.amazonaws.com/media/' + review.image2);
  ratingReview.setAttribute('image3', 'https://dineline.s3.amazonaws.com/media/' + review.image3);

  if (review.hidden) {
    ratingReview.setAttribute('hidden-flag', review.hidden);
  } else {
    // add replies here
    review.comments.forEach(el => {
      if (el.hidden && el.author !== userId) return;
      ratingReview.renderReplies({
        profile: el.profile || DEFAULT_AVATAR,
        text: el.text,
        author: el.author,
        commentId: el.commentId,
        hidden: el.hidden
      })
    });
  }
  reviewWrapper.appendChild(ratingReview);
});

var data = {{ data | safe }};

var addMarkerToMap = function (map, latData, lngData) {
    var marker = new google.maps.Marker({
        position: {
            lat: lat,
            lng: long,
        },
        map: map,
        icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
    });
    marker.setAnimation(google.maps.Animation.DROP);
}

function initMap() {
  const myLatLng = { lat: lat, lng: long };
  const map = new google.maps.Map(document.getElementById("detailMap"), {
    zoom: 15,
    center: myLatLng,
  });
  new google.maps.Marker({
    position: myLatLng,
    map,
    title: yelp_info.name,
  });



    var map2 = new google.maps.Map(document.getElementById('detailMap2'), {
    zoom: 13,
    center: { lat: lat, lng: long },
     mapId: '53f009f8d1f2f7a9'
  });


  map2.data.loadGeoJson('https://dine-safely.s3.amazonaws.com/MODZCTA_2010_WGS1984.geo.json');
  map2.data.setStyle({
        fillColor: 'gray',
        strokeWeight: 1,
        strokeColor: 'white',
    });

  addMarkerToMap(map2, parseFloat(lat), parseFloat(long));

  var infowindow = new google.maps.InfoWindow({maxWidth: 320});

  map2.data.setStyle((feature) => {
    let color = "#91E012";

    record = data[feature.getProperty("MODZCTA").toString()]

    if (record) {
        if (parseFloat(record[1]) > 0 && parseFloat(record[1]) < 1.0) {
          color = "#D7E012";
        }
        if (parseFloat(record[1]) >= 1 && parseFloat(record[1]) < 2) {
          color = "#E0A312";
        }
        if (parseFloat(record[1]) >= 2 && parseFloat(record[1]) < 3) {
          color = "#E05C12";
        }
        if (parseFloat(record[1]) >= 3) {
          color = "#E01412";
        }
    }
    return {
      fillColor: color,
      strokeColor: color,
      strokeWeight: 0.1,
      fillOpacity: 0.8
    };
  });

  map2.data.addListener("click", (event) => {
  });

  map2.data.addListener("mouseover", (event) => {
    map2.data.revertStyle();
    map2.data.overrideStyle(event.feature, { strokeWeight: 2 });
    record = data[event.feature.getProperty("MODZCTA").toString()]
  if (record != null) {
      infowindow.setContent("<div style='width:240px;'>"+"Details:<br>" + "Area: " + record[0] + "<br>percent positivity 7day: " + record[1] + "%" + "<br>People tested: " + record[2] + "<br>People positive " + record[3] +"</div>");
      infowindow.setPosition(event.feature.getProperty("bounds").getCenter());
      infowindow.setOptions({pixelOffset: new google.maps.Size(10,-50)});
      infowindow.open(map2);
    }
  });
  map2.data.addListener("mouseout", (event) => {
    map2.data.revertStyle();
    infowindow.close()
  });

  google.maps.event.addListener(map2.data,'addfeature',function(e){
      //check for a polygon
      if(e.feature.getGeometry().getType()==='Polygon'){
          var bounds=new google.maps.LatLngBounds();
          e.feature.getGeometry().getArray().forEach(function(path){
             path.getArray().forEach(function(latLng){
               bounds.extend(latLng);
             });
          });
          e.feature.setProperty('bounds',bounds);
        }
      });
}
      

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{google_key}}&map_ids={{google_map_id}}&callback=initMap"
    type="text/javascript">
</script>
<script>
  document.getElementById("restaurant_business_id").value = yelp_info.id ;
  document.getElementById("restaurant_business_id_save_favorite").value = yelp_info.id ;
  document.getElementById("restaurant_business_id_delete_favorite").value = yelp_info.id ;
</script>
<script>
            $('body').on('submit', "form[name='saved_res_remove']", function(event) {
                var currentForm = $(this);
                event.preventDefault();
                var formData = currentForm.serialize();
                $.ajaxSetup({
                     beforeSend: function(xhr, settings) {
                         function getCookie(name) {
                             var cookieValue = null;
                             if (document.cookie && document.cookie != '') {
                                 var cookies = document.cookie.split(';');
                                 for (var i = 0; i < cookies.length; i++) {
                                     var cookie = jQuery.trim(cookies[i]);
                                     if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                         cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                         break;
                                     }
                                 }
                             }
                             return cookieValue;
                         }
                         if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                             xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                         }
                     }
                });

                var url = "";
                if (document.getElementById(currentForm.attr("res_business_id")).style.color == "red") {
                    url = "../../delete/favorite/restaurant/" + currentForm.attr("res_business_id");
                } else {
                    url = "../../save/favorite/restaurant/" + currentForm.attr("res_business_id");
                }

                $.ajax({
                  type: 'POST',
                  url: url,
                  data: formData,
                  processData: false,
                  contentType: false,
                  // handle a successful response
                  success : function(response) {
                      if (response == "Saved") {
                        $('#'+currentForm.attr("res_business_id")).css("color", "red");
                      } else {
                        $('#'+currentForm.attr("res_business_id")).css("color", "");
                      }
                  },
                  error : function(xhr,errmsg,err) {
                    console.log('Error')
                  }
                });
            });
</script>
  


{% endblock %}
